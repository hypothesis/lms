version: '3'

services:
  postgres:
    image: postgres:11.5-alpine
    ports:
      - '127.0.0.1:5433:5432'
    healthcheck:
        test: ["CMD", "pg_isready", "-U", "postgres"]
        interval: 1s

  web:
    image: hypothesis/lms:dev
    profiles: ["web"]
    ports:
      - '127.0.0.1:8001:8001'
    # Unfortunately if we don't run as root `dev_host_bridge.sh` doesn't work
    user: root
    command: /bin/sh -c "/var/lib/lms/bin/dev_host_bridge.sh && bin/init-env supervisord -c conf/supervisord.conf"
    environment:
      - DATABASE_URL=postgresql://postgres@lms_postgres_1/postgres
      - FEATURE_FLAGS_COOKIE_SECRET=not_a_secret
      - H_API_URL_PRIVATE=http://host.docker.internal:5000/api/
      - H_API_URL_PUBLIC=http://localhost:5000/api/
      - H_AUTHORITY=lms.hypothes.is
      - RPC_ALLOWED_ORIGINS=http://localhost:5000
      - VIA_URL=http://localhost:9083
      - VIA_SECRET=not_a_secret
      - SESSION_COOKIE_SECRET=notasecret
      - OAUTH2_STATE_SECRET=notasecret
      - JWT_SECRET=${JWT_SECRET}
      - LMS_SECRET=${LMS_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_DEVELOPER_KEY=${GOOGLE_DEVELOPER_KEY}
      - GOOGLE_APP_ID=${GOOGLE_APP_ID}
      - ONEDRIVE_CLIENT_ID=${ONEDRIVE_CLIENT_ID}
      - ADMIN_AUTH_GOOGLE_CLIENT_ID=${ADMIN_AUTH_GOOGLE_CLIENT_ID}
      - ADMIN_AUTH_GOOGLE_CLIENT_SECRET=${ADMIN_AUTH_GOOGLE_CLIENT_SECRET}
      - HASHED_PW=${HASHED_PW}
      - SALT=${SALT}
      - USERNAME=${USERNAME}
      - H_CLIENT_ID=${H_CLIENT_ID}
      - H_CLIENT_SECRET=${H_CLIENT_SECRET}
      - H_JWT_CLIENT_ID=${H_JWT_CLIENT_ID}
      - H_JWT_CLIENT_SECRET=${H_JWT_CLIENT_SECRET}
      - BLACKBOARD_API_CLIENT_ID=${BLACKBOARD_API_CLIENT_ID}
      - BLACKBOARD_API_CLIENT_SECRET=${BLACKBOARD_API_CLIENT_SECRET}
      - VITALSOURCE_LTI_LAUNCH_KEY=${VITALSOURCE_LTI_LAUNCH_KEY}
      - VITALSOURCE_LTI_LAUNCH_SECRET=${VITALSOURCE_LTI_LAUNCH_SECRET}
      - VITALSOURCE_API_KEY=${VITALSOURCE_API_KEY}
